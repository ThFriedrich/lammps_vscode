# This is a syncronisation workflow to that pulls the latest documentation from the lammps repository
# and builds an updated vsix-package based on these files.

name: SYNC

on:
  schedule:
    - cron: '45 11 1 * *'

  workflow_dispatch:
    
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
        
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - name: Cache node modules
      uses: actions/cache@v4
      env:
        cache-name: cache-node-modules
      with:
        path: ~/.npm
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
          
    - name: Download updated Docs
      id: s1
      run: |
        rm -rf rst
        mkdir rst
        cd rst
        git clone --depth=1 --single-branch --branch=release https://github.com/lammps/lammps.git
        cp -r lammps/doc/src/* .
        rm -rf lammps/
        cd ..

    - name: Build Docs TS-Object
      id: s2
      if: steps.s1.conclusion == 'success'
      run: |
        pip3 install numpy --break-system-packages
        python3 ./rst2json/rst2JSON.py
    
    - name: Check for updated docs
      id: s3
      if: steps.s2.conclusion == 'success'
      run: |
        git config --global user.name 'thfriedrich'
        git config --global user.email 'thfriedrich@users.noreply.github.com'
        git config --global pull.rebase true
        git add .
        # Check if Lammps Docs were updated
        if ! [[ $(git status) == *"nothing to commit, working tree clean"* ]]; then
          echo "b_update=true"  >> $GITHUB_ENV
        else
          # Check if vscode-Lammps master branch had commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            # No tags exist, count all commits
            n_com=$(git rev-list --count HEAD)
          else
            # Count commits since last tag
            n_com=$(git rev-list ${LAST_TAG}..HEAD --count)
          fi
          if [ "$n_com" -gt "0" ];then
            echo "b_update=true"  >> $GITHUB_ENV
          fi
        fi

    - name: Build package
      id: s5
      if: steps.s3.conclusion == 'success' && env.b_update == 'true'
      run: |
        # Update package lists and install with retry logic
        sudo apt-get update
        for i in 1 2 3; do
          sudo apt-get install -y imagemagick && break || {
            echo "Attempt $i failed. Retrying in 10 seconds..."
            sleep 10
            sudo apt-get update
          }
        done
        bash ./scripts/resize256.sh
        npm ci  # Use clean install for CI
        npm install @vscode/vsce
        git add .
        
        # Create commit with docs update
        git commit -m "Scheduled sync of lammps_vscode with Lammps documentation $(date +'%Y-%m-%d')"
        
        # Pull latest changes and handle conflicts
        git pull --rebase origin master || {
          echo "Rebase failed, aborting..."
          git rebase --abort
          exit 1
        }
        
        # Bump version (creates another commit)
        npm version patch
        
        # Push both commits
        git push origin master --follow-tags
        
        # Build the package
        npx @vscode/vsce package

    - name: Publish2Marketplace
      id: s6
      if: steps.s5.conclusion == 'success' && env.b_update == 'true'
      run: npx @vscode/vsce publish
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
  
        
        
